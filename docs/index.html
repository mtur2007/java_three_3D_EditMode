<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Three.js æ¨¡å‹ãƒ‡ãƒ¢</title>
  <style>
    @font-face {
      font-family: 'KH Dot Akihabara';
      src: url('fonts/KH-Dot-Akihabara-16.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }
    body { margin: 0; overflow: auto; font-family: 'KH Dot Akihabara', 'Noto Sans JP', system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif; }
    /* Three.js ã®ã‚­ãƒ£ãƒ³ãƒã‚¹çŠ¶æ…‹ */
    #three-canvas.full-canvas {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      display: block;
      z-index: 0;
      background: transparent;
    }
    #three-canvas.intro-canvas {
      position: relative;
      /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚ã¯ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã‚’è‡ªå‹•ã«ã—ã¦è¦ªè¦ç´ å†…ã§ä¸­å¤®ã«é…ç½®ã™ã‚‹ */
      width: auto;
      height: auto;
      max-width: 100%;
      max-height: 100%;
      display: block;
      margin: auto;
      z-index: 0;
      background: transparent;
      border-radius: 6px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.6);
    }
  </style>
  <style>
    /* LED-style marquee (é›»å…‰æ²ç¤ºæ¿é¢¨) */
    .led-marquee {
      overflow: hidden;
      background: rgba(0,0,0,0.85);
      color: #00ff66;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 18px;
      line-height: 1;
      box-shadow: 0 4px 18px rgba(0,0,0,0.6);
      display: block;
      width: 100%;
      box-sizing: border-box;
      -webkit-font-smoothing: antialiased;
      font-variant-ligatures: none;
    }
    .led-marquee__inner {
      
      display: grid;
      grid-template-rows: repeat(3, 1fr);
      align-items: center;
      gap: 0; /* å˜ä¸€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’1å›æµã™ãŸã‚ gap ã¯ä¸è¦ */
      white-space: nowrap;
      will-change: transform;
      animation-timing-function: linear;

      /* animation-name / duration ã¯ JS ã§è¨­å®š */
    }
    .led-marquee__text { display: inline-block; }
    .led-marquee:hover .led-marquee__inner { animation-play-state: paused; }
    
    @keyframes marquee {
      from { transform: translateX(var(--marquee-from, 100%)); }
      to   { transform: translateX(var(--marquee-to, -100%)); }
    }

    /* å·¦å›ºå®šè¡¨ç¤ºï¼ˆæµã•ãªã„è¡Œï¼‰ */
    .led-row.static .led-marquee__text{
      transform: none !important;
    }

    /* static ã®æ™‚ã¯ inner å…¨ä½“ã®ã‚¢ãƒ‹ãƒ¡ã‚’ä½¿ã‚ãªã„ã®ã§ã€è¡Œå˜ä½ã§åˆ¶å¾¡ã™ã‚‹ */
    .led-row .led-marquee__text{
      will-change: transform;
    }

    @keyframes marqueeRow {
      from { transform: translateX(var(--row-from, 100%)); }
      to   { transform: translateX(var(--row-to, -100%)); }
    }

    .led-color-white  { color:#ffffff; text-shadow:0 0 8px rgba(255,255,255,.8); }
    .led-color-green  { color:#00ff66; text-shadow:0 0 8px rgba(0,255,102,.8); }
    .led-color-orange { color:#ffb347; text-shadow:0 0 8px rgba(255,77,77,.8); }
    .led-color-red    { color:#ff4d4d; text-shadow:0 0 8px rgba(255,77,77,.8); }
    .led-color-blue   { color:#7be6ff; text-shadow:0 0 8px rgba(123, 143, 255, 0.8); }
    .led-color-yellow { color:#ffe35a; text-shadow:0 0 8px rgba(255,227,90,.8); }
    .led-color-pink   { color:#ff69b4; text-shadow:0 0 8px rgba(255,105,180,.8); }

    .led-row.theme-orange .led-marquee__text { color:#ff6200; text-shadow:0 0 10px rgba(255,77,77,.8); }
    .led-row.theme-green .led-marquee__text { color:#00ff66b8; text-shadow:0 0 10px rgba(0, 255, 102, 0.507); }
    .led-row.theme-alert .led-marquee__text { color:#ff4d4d; text-shadow:0 0 10px rgba(255,77,77,.8); }
    .led-row.theme-info  .led-marquee__text { color:#7be6ff; text-shadow:0 0 10px rgba(123,230,255,.7); }
    .led-row.theme-local .led-marquee__text { color:#ffe35a; text-shadow:0 0 10px rgba(255,227,90,.7); }


  </style>
    <style>
      /* Welcome overlay: disable internal scrolling so page scroll controls navigation */
        #welcome { overflow: visible; -webkit-overflow-scrolling: auto; }
        .welcome-content { max-height: none; overflow: visible; -webkit-overflow-scrolling: auto; }
    </style>
  <style>
    /* æ“ä½œèª¬æ˜ãƒ‘ãƒãƒ« */
    #instructions-panel {
      position: fixed;
      top: 80px;
      /* width: 320px; */
      max-width: calc(100% - 32px);
      max-height: calc(80vh);
      overflow: auto;
      background: rgba(255,255,255,0.95);
      color: #111;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.2);
      z-index: 9999;
      display: none;
      font-size: 14px;
      line-height: 1.5;
    }
    #show-instructions-btn {
      position: fixed;
      right: 12px;
      top: 20px;
      z-index: 10000;
      padding: 8px 12px;
      background: rgba(0,0,0,0.6);
      color: white;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      backdrop-filter: blur(4px);
      touch-action: manipulation;
    }
  </style>

  <style>
    /* Canvas ä¸Šã«é‡ã­ã‚‹ UI ç”¨ã‚³ãƒ³ãƒ†ãƒŠ */
    #three-ui {
      position: absolute; /* intro æ™‚ã¯ intro-wrapper å†…ã§ç›¸å¯¾é…ç½® */
      inset: 0;
      pointer-events: none; /* å­è¦ç´ ã®ã¿åå¿œã•ã›ã‚‹ */
      z-index: 2;
    }
    /* canvas å†…ã«ç§»å‹•ã—ãŸ UI è¦ç´ ã¯ã“ã‚Œã‚’ä»˜ä¸ã—ã¦æ“ä½œå¯èƒ½ã«ã™ã‚‹ */
    .canvas-ui { pointer-events: auto; }
  </style>

  <style>
    /* æ‹¡å¤§è¡¨ç¤ºæ™‚ã« canvas ã®ã¿è¡¨ç¤ºã™ã‚‹ã‚¯ãƒ©ã‚¹ */
    body.only-canvas > * { display: none !important; }
    body.only-canvas #three-canvas {
      display: block !important;
      position: fixed !important;
      inset: 0 !important;
      width: 100% !important;
      height: 100% !important;
      z-index: 2147483646 !important;
      background: transparent !important;
    }
    /* ãŸã ã— three-uiï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹ä¸Šã® UIï¼‰ã¯è¡¨ç¤ºã™ã‚‹ */
    body.only-canvas #three-ui { display: block !important; position: fixed !important; inset: 0 !important; z-index: 2147483647 !important; pointer-events: auto !important; }
    body.only-canvas .canvas-ui { pointer-events: auto !important; }
  </style>

  <!-- Google Analytics è¨­å®š é–²è¦§æ•°ã®æ¸¬å®šç”¨ã§ã™ã€‚-->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-B8X9Y12345"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-E7Z2FM74H9');
  </script>
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.169.0/build/three.module.js"
    }
  }
  </script>
</head>
<body>
<!--   
  <button id="speed-up" class="no-touch-highlight" style="position: fixed; left: 20px; bottom: 200px; width: 60px; height: 60px; font-size: 24px; border-radius: 30px; z-index: 20; opacity: 0.3;">â–¶ï¸â–·</button>

  <button id="speed-down" class="no-touch-highlight" style="position: fixed; left: 95px; bottom: 200px; width: 60px; height: 60px; font-size: 24px; border-radius: 30px; z-index: 20; opacity: 0.3;">â—€ï¸â—</button>
  
  <button id="btn-up" class="no-touch-highlight" style="position: fixed; left: 20px; bottom: 120px; width: 60px; height: 60px; font-size: 24px; border-radius: 30px; z-index: 20; opacity: 0.3;">ğŸ”º</button>
  
  <button id="btn-down" class="no-touch-highlight" style="position: fixed; left: 20px; bottom: 40px; width: 60px; height: 60px; font-size: 24px; border-radius: 30px; z-index: 20; opacity: 0.3;">ğŸ”»</button> -->
  <style>
    .section {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.6);
      z-index: 200;
      min-height: 80vh; /* å°‘ã—çŸ­ã‚ã«ã—ã¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–“ã®ä½™ç™½ã‚’æ¸›ã‚‰ã™ */
      padding: 12px 0 0 0;  /* ä¸Šæ–¹å‘ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã®ã¿ã«ã—ã¦ä¸‹ä½™ç™½ã‚’ç„¡ãã™ */
      margin: 0; /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–“ã®å¤–å´ã®ä½™ç™½ã‚’ç„¡ãã™ */
    }

    /* é€£ç¶šã™ã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–“ã®éš™é–“ã‚’ã‚¼ãƒ­ã«ã™ã‚‹ */
    .section + .section { margin-top: 0; padding-top: 0; }

    /* Welcome ã®å†…å´ä½™ç™½ã‚‚è©°ã‚ã‚‹ */
    .welcome-content { margin-bottom: 0; padding-bottom: 0; }

    .control-button {
      position: relative;
      width: 60px;
      height: 60px;
      font-size: 24px;
      border: none;
      border-radius: 30px;
      background-color: rgba(255, 255, 255, 0.2); /* é€éã£ã½ã„ */
      color: white;
      z-index: 20;
      backdrop-filter: blur(4px); /* iOSã£ã½ã„ã‚¬ãƒ©ã‚¹æ„Ÿ */
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      transition: all 0.1s ease-in-out;
      
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
    }

  .control-square-button {
    position: relative;
    width: 400px;
    height: 40px;
    font-size: 24px;
    border: none;
    border-radius: 4px; /* â† å››è§’ã£ã½ã„è§’ä¸¸ï¼ˆå®Œå…¨ã«å››è§’ãªã‚‰ 0 ã«ï¼‰ */
    background-color: rgba(255, 255, 255, 0.2);
    color: white;
    z-index: 20;
    backdrop-filter: blur(4px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    transition: all 0.1s ease-in-out;

    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
  }
  .log-control-square-button {
    position: relative;
    width: 800px;
    height: 400px;
    font-size: 24px;
    border: none;
    border-radius: 4px; /* â† å››è§’ã£ã½ã„è§’ä¸¸ï¼ˆå®Œå…¨ã«å››è§’ãªã‚‰ 0 ã«ï¼‰ */
    background-color: rgba(255, 255, 255, 0.2);
    color: white;
    z-index: 20;
    backdrop-filter: blur(4px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    transition: all 0.1s ease-in-out;

    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
  }

  /* ãƒ›ãƒãƒ¼ï¼ˆãƒã‚¦ã‚¹ã‚’ä¹—ã›ãŸã¨ãï¼‰ã§æš—ãã™ã‚‹ */
  .control-button:hover {
    filter: brightness(85%);
    cursor: pointer;
  }

  /* ã‚¯ãƒªãƒƒã‚¯ä¸­ï¼ˆæŠ¼ã—ã¦ã‚‹æœ€ä¸­ï¼‰ã§ã•ã‚‰ã«æš—ãã™ã‚‹ */
  .control-button:active {
    filter: brightness(70%);
  }

  /* ã‚¢ã‚¤ã‚³ãƒ³ã®é‡ã­ãƒ©ãƒƒãƒ‘ãƒ¼ */
  .icon-wrapper {
    position: relative;
    display: flex;              /* ä¸­å¤®å¯„ã›ç”¨ */
    align-items: center;        /* ç¸¦ä¸­å¤® */
    justify-content: center;    /* æ¨ªä¸­å¤® */
    width: 2em;                 /* ãƒœã‚¿ãƒ³ã«åˆã‚ã›ã¦å¤§ãã‚ã« */
    height: 2em;
    }

  /* è–„ã„èƒŒæ™¯è¨˜å· */
  .background-icon {
    position: absolute;
    color: rgba(0, 0, 0, 0.5);
    font-size: 1.5em;
  }
  /* æ¿ƒã„å‰é¢è¨˜å· */
  .foreground-icon {
    position: absolute;
    color: black;
    font-size: 1.3em;
  }
  
  .credits-footer {
    position: relative;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255,255,255,0.9);
    padding: 6px 12px;
    font-size: 12px;
    text-align: center;
    z-index: 9999;
    box-shadow: 0 -1px 6px rgba(0,0,0,0.12);
  }
  .credits-footer a { color: #0645ad; text-decoration: underline; }

  /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .circle-ctrl-area {
    position: absolute;
    border-radius: 50%;
    background: rgba(255,255,255,0.95);
    background: rgba(0,0,0,0.5);
    border: 2px solid #333;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    transform: translate(-50%, -50%); /* left/top ã‚’ä¸­å¿ƒã«ã™ã‚‹ */
    display: flex;
    align-items: center;
    justify-content: center;
    user-select: none;
    touch-action: none;
    cursor: grab;
    pointer-events: auto;
  }
  /* .circle-ctrl-area { cursor: grabbing; } */

  .circle-ctrl {
    position: absolute;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: rgba(0,0,0,0.5);
    border: 2px solid #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    transform: translate(-50%, -50%); /* left/top ã‚’ä¸­å¿ƒã«ã™ã‚‹ */
    display: flex;
    align-items: center;
    justify-content: center;
    user-select: none;
    touch-action: none;
    cursor: grab;
    pointer-events: auto;
  }
  /* .circle-ctrl:active { cursor: grabbing; } */
  #UiGroup {
    position: relative; /* ã“ã“ã‚’åŸºæº–ã«ã™ã‚‹ */
    width: 10%;
    height: 590px;
    border: 1px solid rgba(221, 221, 221, 0.2); /* é€æ˜åº¦ 0.5 (=50%) */
  }
  #UiGroup button {
    position: absolute; /* top ãŒåŠ¹ãã‚ˆã†ã«ã™ã‚‹ */
    left: 0;
    width: 72px;
    height: 28px;
  }

</style>
  

  <!-- Welcome overlay with a scaled-down canvas preview -->
  <section id="welcome" class="section">
      <div class="welcome-content" style="width: 80%; max-width: 960px; background: rgba(255,255,255,0.06); padding: 24px; border-radius: 12px; backdrop-filter: blur(6px);"> 
      <div class="led-marquee" aria-label="announcement">

        <div class="led-marquee__inner" id="led-marquee-inner">
          <div class="led-row" data-row="0"><span class="led-marquee__text"></span></div>
          <div class="led-row" data-row="1"><span class="led-marquee__text"></span></div>
          <div class="led-row" data-row="2"><span class="led-marquee__text"></span></div>
        </div>

      </div>
      <div style="display:flex; gap:16px; align-items:center; flex-wrap:wrap;">
        <div id="intro-wrapper" style="flex: 1 1 480px; max-width: 640px; background: rgba(0,0,0,0.4); padding: 8px; border-radius: 8px; display:flex; align-items:center; justify-content:center; position: relative;">
          <canvas id="three-canvas"></canvas>
          <!-- three-ui: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚ã¯ã“ã“ã«ãƒœã‚¿ãƒ³ç¾¤ã‚’è¡¨ç¤º -->
          <div id="three-ui">
            <div class="canvas-ui">
              <button id="speed-up" class="control-button" style="right: 20px; bottom: 200px;">â—€ï¸â—</button>
              <button id="speed-down" class="control-button" style="right: 95px; bottom: 200px;">â–¶ï¸â–·</button>
              <button id="btn-up" class="control-button" style="right: 160px; bottom: 150px;">ğŸ”º</button>
              <button id="btn-down" class="control-button" style="right: 160px; bottom: 70px;">ğŸ”»</button>

              <button id="controller-area" class="circle-ctrl-area" style="left: 160px; bottom: 60px; width: 80px; height: 80px"></button>
              <button id="controller" class="circle-ctrl" style="left: 160px; bottom: 110px; width: 30px; height: 30px"></button>

              <button id="log" class="control-button" style="right: 20px; top: 40px;">ğŸ“¤</button>

              <div id="UiGroup" style="position: fixed; top: 140px; left: 20px; z-index: 100;">
                <button id = 'see' style = 'top: 10px;' > ğŸ¦ </button>
                <button id = 'edit' style = 'top: 40px;' > ğŸ› ï¸ </button>
                <button id = 'rail' style = 'top: 70px; left:10px;' > ğŸ›¤ï¸ </button>
                <button id = 'new' style = 'top: 100px; left:20px;' > + </button>
                <button id = 'move' style = 'top: 130px; left:20px;' > ğŸ’« </button>
                <button id = 'x_z' style = 'top: 160px; left:30px;' > â¤® </button>
                <button id = 'y' style = 'top: 190px; left:30px;' > â‡¡ </button>
                <button id = 'structure' style = 'top: 130px; left:80px;' > ğŸŒ‰</button>
                <button id = 'new/2' style = 'top: 160px; left:90px;' > + </button>
                <button id = 'construction' style = 'top: 190px; left:90px;' > ğŸ—ï¸ </button>

              </div>

              <button id="toggle-crossover" class="control-square-button" style="position: absolute; left: 20px; top: 20px; padding: 10px; font-size: 14px; z-index: 10; backdrop-filter: blur(4px);">ãƒ©ãƒ³ãƒ€ãƒ ç«‹ä½“äº¤å·®ï¼ˆã‚¯ã‚¢ãƒˆãƒ­äº¤å·®ï¼‰åˆ‡æ›¿</button>

              <div id="frontViewButtons" style="position: fixed; top: 20px; right: 20px; z-index: 100;">
                <button class="frontViewBtn" data-train="1">1ç•ªç·š</button>
                <button class="frontViewBtn" data-train="2">2ç•ªç·š</button>
                <button class="frontViewBtn" data-train="3">3ç•ªç·š</button>
                <button class="frontViewBtn" data-train="4">4ç•ªç·š</button>
              </div>

              <button id="toggle-daynight" style="position: absolute; top: 70px; left: 20px; z-index: 10; padding: 10px 15px; font-size: 16px; border-radius: 8px;">ğŸŒ™ å¤œã«ã™ã‚‹</button>

              <button id="save-track-data" class="control-square-button" style="position: absolute; left: 20px; top: 120px; padding: 10px; font-size: 14px; z-index: 10; backdrop-filter: blur(4px);">è»Œé“ä¿å­˜</button>
              <button id="save-structure-data" class="control-square-button" style="position: absolute; left: 20px; top: 170px; padding: 10px; font-size: 14px; z-index: 10; backdrop-filter: blur(4px);">ãƒ”ãƒ³ä¿å­˜</button>

              <button id = "logwindow" class="log-control-square-button" style="position: absolute; left: 130px; top: 20px; padding: 10px; font-size: 14px; color: #000; z-index: 10; backdrop-filter: blur(4px);">ãƒ¢ãƒã‚¤ãƒ«å‡ºåŠ›ç”¨</button>
              
              <button id="show-instructions-btn">æ“ä½œèª¬æ˜</button>

              <div id="instructions-panel" role="region" aria-label="æ“ä½œèª¬æ˜">
                <h3 style="margin-top:0;">æ“ä½œèª¬æ˜</h3>
                <ul>
                  [è¦–ç‚¹] ç”»é¢ä¸Šã‚’ã‚¹ãƒ©ã‚¤ãƒ‰/ãƒ‰ãƒ©ãƒƒã‚°ã§è¦–ç‚¹ã‚’å›è»¢ãƒ»ç§»å‹•ã—ã¾ã™ã€‚<br>
                  [ç§»å‹•] å·¦ä¸‹ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã§å‰å¾Œå·¦å³ã«ç§»å‹•ã§ãã¾ã™ã€‚<br>
                  [è¡¨ç¤ºåˆ‡æ›¿] å³ä¸Šã®ãƒœã‚¿ãƒ³ã§åˆ—è»Šãƒ“ãƒ¥ãƒ¼ç­‰ã‚’åˆ‡æ›¿ãˆã¾ã™ã€‚<br>
                  [ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³] ã€Œè¡¨ç¤ºã‚’é–‹å§‹ã™ã‚‹ã€ã§ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¡¨ç¤ºã«åˆ‡æ›¿ã€å†åº¦ã€Œæ“ä½œèª¬æ˜ã€ã‚’é–‰ã˜ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«æˆ»ã›ã¾ã™ã€‚
                </ul>
                <p style="margin-bottom:0;">â€» ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ç”»é¢ã‚’é•·æŠ¼ã—ã™ã‚‹ã¨ã‚ºãƒ¼ãƒ ã—ã¾ã™ã€‚</p>
              </div>

            </div>
          </div>
        </div>
        <div style="flex: 1 1 260px; min-width: 220px;">
          <div id="preview-feature" style="margin:12px 0; padding:16px; background: rgba(255,255,255,0.04); border-radius:10px; text-align:center;">
            <h2 style="margin:0 0 8px 0; font-size:18px;">æ“ä½œèª¬æ˜</h2>
            <ul>
                  [è¦–ç‚¹] ç”»é¢ä¸Šã‚’ã‚¹ãƒ©ã‚¤ãƒ‰/ãƒ‰ãƒ©ãƒƒã‚°ã§è¦–ç‚¹ã‚’å›è»¢ãƒ»ç§»å‹•ã—ã¾ã™ã€‚<br>
                  [ç§»å‹•] å·¦ä¸‹ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã§å‰å¾Œå·¦å³ã«ç§»å‹•ã§ãã¾ã™ã€‚<br>
                  [è¡¨ç¤ºåˆ‡æ›¿] å³ä¸Šã®ãƒœã‚¿ãƒ³ã§åˆ—è»Šãƒ“ãƒ¥ãƒ¼ç­‰ã‚’åˆ‡æ›¿ãˆã¾ã™ã€‚<br>
                  [ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³] ã€Œè¡¨ç¤ºã‚’é–‹å§‹ã™ã‚‹ã€ã§ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¡¨ç¤ºã«åˆ‡æ›¿ã€å†åº¦ã€Œæ“ä½œèª¬æ˜ã€ã‚’é–‰ã˜ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«æˆ»ã›ã¾ã™ã€‚
            </ul>
            <p style="margin-bottom:0;">â€» ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ç”»é¢ã‚’é•·æŠ¼ã—ã™ã‚‹ã¨ã‚ºãƒ¼ãƒ ã—ã¾ã™ã€‚</p>

          </div>
        </div>
      </div>
      <div style="flex: 1 1 260px; min-width: 220px;">
        <div id="preview-feature" style="margin:12px 0; padding:16px; background: rgba(255,255,255,0.04); border-radius:10px; text-align:center;">
          <h2 style="margin:0 0 8px 0; font-size:18px;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ æ“ä½œãƒ‘ãƒãƒ«</h2>
          <p style="margin:0 0 12px 0; opacity:0.9;">ã“ã“ã‹ã‚‰ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¡¨ç¤ºã«åˆ‡æ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚</p>
          <div style="display:flex; gap:10px; justify-content:center;">
            <button id="preview-start" style="padding:14px 20px; font-size:18px; border-radius:10px; background:#0078d4; color:#fff; border:none;">è¡¨ç¤ºã‚’é–‹å§‹ã™ã‚‹</button>
            <button id="preview-skip" style="padding:12px 16px; font-size:16px; border-radius:10px; background:rgba(0,0,0,0.6); color:#fff; border:none;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã¾ã¾é–‰ã˜ã‚‹</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section id="operation" class="section">
    <div style="width: 80%; max-width: 960px; background: rgba(255,255,255,0.06); padding: 24px; border-radius: 12px; backdrop-filter: blur(6px); color: white;"> 
      <h1 style="margin-top: 0;">ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®èª¬æ˜</h1>
      
      <p>ã“ã®ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€è·¯ç·šç·¨é›†ãƒ»æ§‹é€ ç‰©ç”Ÿæˆãƒ»ãƒ”ãƒ³é…ç½®ãŒã§ãã¾ã™ã€‚</p>
      <ul style="margin: 8px 0 16px 18px; line-height: 1.7;">
        <li><strong>ğŸ› ï¸ edit</strong>: ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®é–‹å§‹ã€‚</li>
        <li><strong>ğŸ›¤ï¸ rail</strong>: è»Œé“è¡¨ç¤ºãƒ»åˆ¶å¾¡ç‚¹ç·¨é›†ï¼ˆmove / x_z / yï¼‰ã€‚</li>
        <li><strong>ğŸŒ‰ structure â†’ new</strong>: è»Œé“ä¸Šã«ãƒ”ãƒ³ã‚’è¿½åŠ ã€‚</li>
        <li><strong>ğŸ—ï¸ construction</strong>: è¿½åŠ ã—ãŸãƒ”ãƒ³ã‚’é¸æŠã—ã€bridge / elevated / wall / floor / pillar / rib_bridge ã‚’ç”Ÿæˆã€‚</li>
        <li><strong>ãƒ”ãƒ³ä¿å­˜</strong>: ç¾åœ¨ã®ãƒ”ãƒ³é…ç½®ã‚’ `structure.json` ã¨ã—ã¦ä¿å­˜ã€‚</li>
      </ul>
      
      <div style="display:flex; gap:16px; align-items:center; flex-wrap:wrap;">
        <div id="intro-wrapper" style="flex: 1 1 480px; max-width: 640px; background: rgba(0,0,0,0.4); padding: 8px; border-radius: 8px; display:flex; align-items:center; justify-content:center; position: relative;">
          <canvas id="three-canvas"></canvas>
          <!-- three-ui: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚ã¯ã“ã“ã«ãƒœã‚¿ãƒ³ç¾¤ã‚’è¡¨ç¤º -->
        </div>
      <p style="opacity:0.8; font-size:13px; margin-top:12px;">â€» ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ã‚¿ãƒƒãƒæ“ä½œã€ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§ã¯ãƒã‚¦ã‚¹ã§æ“ä½œã§ãã¾ã™ã€‚</p>
    </div>
  </section>
  
  <footer class="credits-footer" role="contentinfo" aria-label="å‡ºå…¸æƒ…å ±">
    <small>

      (â„¹ï¸ <a id="show-intro-link" href="https://github.com/mtur2007/java_three_3D/blob/main/README.md" target="_blank" rel="noopener noreferrer">æ“ä½œæ–¹æ³•ã¯ã“ã¡ã‚‰</a>)
      [ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ / 
      ãƒ‡ãƒ¼ã‚¿:
      <a href="https://plateauview.mlit.go.jp/" target="_blank" rel="noopener noreferrer">PLATEAU</a>ï¼ˆå›½åœŸäº¤é€šçœï¼‰|
      ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚º: 
      <a href="https://threejs.org/" target="_blank" rel="noopener noreferrer">
      three.js (r0.169.0, MIT)</a> | 
      å¤‰æ›: 
      <a href="https://github.com/Project-PLATEAU/PLATEAU-GIS-Converter" target="_blank" rel="noopener noreferrer">
      PLATEAU GIS Converter</a> ]
    </small>
  </footer>
  
  <script type="module" src="js/main.js"></script>
  <script type="module" src="js/ui_toggle.js"></script>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const inner = document.getElementById('led-marquee-inner');
  if (!inner) return;

  // 3è¡Œã‚»ãƒƒãƒˆï¼štext ã¨ mode ã‚’è¡Œã”ã¨ã«æŒ‡å®š
  // mode: "scroll" | "static"
  const messageSets = [
    [
      { text: '</whiteã‚ˆã†ã“ã â€” ä¸‰æ¬¡å…ƒæ¨¡å‹ãƒ‡ãƒ¢', mode: 'static' },
      { text: '</orangeã“ã®ã‚µã‚¤ãƒˆã§ã¯three.jsã§ä½œæˆã—ãŸç©ºé–“ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚', mode: 'scroll' },
      { text: '', mode: 'static' },
    ],
    [
      { text: '</whiteã‚ˆã†ã“ã â€” ä¸‰æ¬¡å…ƒæ¨¡å‹ãƒ‡ãƒ¢', mode: 'static' },
      { text: '</orangeã¾ãšã¯ç¸®å°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§æ“ä½œæ„Ÿã‚’ãŠè©¦ã—ãã ã•ã„ã€‚', mode: 'scroll' },
      { text: '', mode: 'static' },
    ],
    [
      { text: '</redã²ã‹ã‚Š 513', mode: 'static' },
      { text: '</yellowã®ãã¿ 111 ', mode: 'static' },
      { text: '</blueãŸã‹ã— 657', mode: 'static' },
    ],
    [
      { text: '</greenã€€ã€€æ™®ã€€é€šã€€ã€€ 15:06 éƒ¡å±±</orange 2', mode: 'static' },
      { text: '</redå–œå¤šæ–¹ãƒ©ãƒ¼ãƒ¡ãƒ³ 15:25 éƒ¡å±± 1', mode: 'static' },
      { text: '', mode: 'static' },
    ],
    [
      { text: '</pink ï¼“ </yellow 16:26 å„åœ æ–°ç·šæ–°å®¿ ï¼‘ï¼ä¸¡ç·¨æˆ', mode: 'static' },
      { text: '</pink ï¼“ </yellow 16:27 å„åœ ã€€èª¿å¸ƒã€€ ï¼“ï¼’ï¼—ï¼’ï¼–ï¼˜ä¸¡ç·¨æˆ', mode: 'static' },
      { text: '', mode: 'static' },

    ],
    [
      { text: '</orangeâ˜†æ—¥æœ¬ã¯çµ‚äº†ã—ã¾ã—ãŸâ˜†', mode: 'static' },
      { text: '', mode: 'static' },
      { text: '', mode: 'static' },
    ],
    [
      { text: '</white local</orange 12:38 Naka-meguro </green8car', mode: 'static' },
      { text: '</orangeæ’ƒã¡å›ã‚Šã€å¤–å›ã‚Šé›»è»Šã«é…ã‚ŒãŒå‡ºã¦ãŠã‚Šã¾ã™ã€‚', mode: 'scroll' },
      { text: '</white local</orange 12:48 Naka-meguro </green7car', mode: 'static' },
    ],
    [
      { text: '</greenæ¬¡ã¯ã€€</orangeã‚ªãƒã‚¨ãƒ€', mode: 'static' },
      { text: '', mode: 'static' },
      { text: '', mode: 'static' },
    ],
    [
      { text: '</greenã€€ã€€æ™®ã€€é€šã€€ã€€21:01 è±Šã€€æ©‹ 4ä¸¡', mode: 'static', theme: 'green' },
      { text: '</orangeãŠå®¢æ§˜ã«ã¯å¤§å¤‰ã”è¿·æƒ‘ã—ã¦ãŠã‚Šã¾ã™ã€‚', mode: 'scroll', theme: 'orange'},
      { text: '', mode: 'static' },
    ],
  ];

  const SPEED_PX_PER_SEC = 120;
  const MIN_SEC = 5;
  const MAX_SEC = 120;

  // ãƒ•ã‚©ãƒ³ãƒˆãƒ­ãƒ¼ãƒ‰å¾Œã«è¨ˆæ¸¬ï¼ˆä»»æ„ã ã‘ã©ãŠã™ã™ã‚ï¼‰
  if (document.fonts && document.fonts.ready) {
    try { await document.fonts.ready; } catch (e) {}
  }

  let queue = [];
  let currentIndex = -1;

  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }
  function refillQueue() {
    queue = messageSets.map((_, i) => i);
    shuffle(queue);
    if (queue.length >= 2 && queue[0] === currentIndex) {
      [queue[0], queue[1]] = [queue[1], queue[0]];
    }
  }
  function pickNextIndex() {
    if (messageSets.length === 0) return -1;
    if (messageSets.length === 1) return 0;
    if (queue.length === 0) refillQueue();
    return queue.shift();
  }

  function parseColoredText(raw) {
    if (!raw) return '';

    // </colorText ã‚’è§£æ
    // ä¾‹: </greenæ¬¡ã¯ </orangeã‚ªãƒã‚¨ãƒ€
    const regex = /<\/([a-zA-Z0-9_-]+)([^<]*)/g;

    let result = '';
    let lastIndex = 0;
    let match;

    while ((match = regex.exec(raw)) !== null) {
      // ã‚¿ã‚°å‰ã®é€šå¸¸æ–‡å­—
      result += raw.slice(lastIndex, match.index);

      const color = match[1];
      const text  = match[2];

      result += `<span class="led-color-${color}">${text}</span>`;

      lastIndex = regex.lastIndex;
    }

    // æ®‹ã‚Šæ–‡å­—
    result += raw.slice(lastIndex);

    return result;
  }

  function applyRow(rowEl, line) {

    const span = rowEl.querySelector('.led-marquee__text');
    if (!span) return;

    const mode = line?.mode ?? 'scroll';
    const text = line?.text ?? '';

    // ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°
    span.innerHTML = parseColoredText(text);


    // ãƒ¢ãƒ¼ãƒ‰åæ˜ ï¼ˆclassã§åˆ†ã‘ã‚‹ï¼‰
    rowEl.classList.toggle('static', mode === 'static');

    // ã‚¢ãƒ‹ãƒ¡ä¸€æ—¦åœæ­¢ï¼†ã‚¯ãƒªã‚¢
    span.style.animation = 'none';
    span.style.transform = 'translateX(0px)';
    span.style.removeProperty('--row-from');
    span.style.removeProperty('--row-to');
  }

  function startRowAnimation(rowEl) {
    const span = rowEl.querySelector('.led-marquee__text');
    if (!span) return;

    // static ã®è¡Œã¯æµã•ãªã„ï¼ˆå·¦å›ºå®šï¼‰
    if (rowEl.classList.contains('static')) {
      span.style.animation = 'none';
      span.style.transform = 'translateX(0px)';
      return;
    }

    const container = inner.parentElement;
    if (!container) return;

    const containerWidth = container.getBoundingClientRect().width;
    const textWidth = span.getBoundingClientRect().width;

    const from = containerWidth;
    const to = -textWidth;

    span.style.setProperty('--row-from', from + 'px');
    span.style.setProperty('--row-to', to + 'px');

    const distance = containerWidth + textWidth;
    const raw = distance / SPEED_PX_PER_SEC;
    const duration = Math.max(MIN_SEC, Math.min(MAX_SEC, raw));

    // ç¢ºå®Ÿã«ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ
    span.style.animation = 'none';
    void span.offsetWidth;
    span.style.animation = `marqueeRow ${duration}s linear 1 forwards`;
  }

  // 3è¡Œã®ã†ã¡ã€Œæœ€å¾Œã«çµ‚ã‚ã£ãŸ scroll è¡Œã€ã‚’ãƒˆãƒªã‚¬ãƒ¼ã«æ¬¡ã‚»ãƒƒãƒˆã¸
  // â€» ã™ã¹ã¦ static ã®ã‚»ãƒƒãƒˆã§ã‚‚é€²ã‚€ã‚ˆã†ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚‚å…¥ã‚Œã‚‹
  let pendingScrollCount = 0;

  function playSet(index) {
    const set = messageSets[index];
    const rows = inner.querySelectorAll('.led-row');

    pendingScrollCount = 0;

    rows.forEach((rowEl, i) => {
      applyRow(rowEl, set[i]);
    });

    // DOMåæ˜ å¾Œã«è¨ˆæ¸¬ã—ã¦é–‹å§‹
    requestAnimationFrame(() => {
      rows.forEach((rowEl) => {
        if (!rowEl.classList.contains('static')) pendingScrollCount++;
        startRowAnimation(rowEl);
      });

      // å…¨éƒ¨ static ã®ã‚»ãƒƒãƒˆãªã‚‰ã€ä¸€å®šæ™‚é–“å¾Œã«æ¬¡ã¸ï¼ˆè¦‹ã›ã‚‹æ™‚é–“ï¼‰
      if (pendingScrollCount === 0) {
        setTimeout(() => playNext(),  8000);
      }
    });
  }

  function playNext() {
    const next = pickNextIndex();
    if (next < 0) return;
    currentIndex = next;
    playSet(currentIndex);
  }

  // è¡Œã‚¢ãƒ‹ãƒ¡çµ‚äº†ã‚’ç›£è¦–ï¼ˆscroll è¡Œã ã‘ã‚«ã‚¦ãƒ³ãƒˆï¼‰
  inner.addEventListener('animationend', (e) => {
    const span = e.target.closest?.('.led-marquee__text');
    if (!span) return;

    const rowEl = span.closest('.led-row');
    if (!rowEl || rowEl.classList.contains('static')) return;

    pendingScrollCount = Math.max(0, pendingScrollCount - 1);
    if (pendingScrollCount === 0) {
      playNext();
    }
  });

  // hoverã§åœæ­¢ï¼ˆè¡Œã”ã¨ï¼‰
  const marquee = inner.closest('.led-marquee');
  if (marquee) {
    marquee.addEventListener('mouseenter', () => {
      inner.querySelectorAll('.led-marquee__text').forEach(s => s.style.animationPlayState = 'paused');
    });
    marquee.addEventListener('mouseleave', () => {
      inner.querySelectorAll('.led-marquee__text').forEach(s => s.style.animationPlayState = 'running');
    });
  }

  // ãƒªã‚µã‚¤ã‚ºæ™‚ï¼šä»Šã®ã‚»ãƒƒãƒˆã‚’å†ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆã‚ºãƒ¬é˜²æ­¢ï¼‰
  const handleResize = () => {
    if (currentIndex < 0) return;
    playSet(currentIndex);
  };
  if ('ResizeObserver' in window) {
    const ro = new ResizeObserver(() => handleResize());
    ro.observe(inner.parentElement);
  } else {
    window.addEventListener('resize', handleResize, { passive: true });
  }

  playNext();
});
</script>

</body>
</html>
