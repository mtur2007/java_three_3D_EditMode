<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>éƒ½å¸‚ã‚’èµ°ã‚‹é‰„é“æ¨¡å‹ DEMO</title>
  <style>
    @font-face {
      font-family: 'KH Dot Akihabara';
      src: url('fonts/KH-Dot-Akihabara-16.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }
    body { margin: 0; overflow: auto; font-family: 'KH Dot Akihabara', 'Noto Sans JP', system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif; }
    /* Three.js ã®ã‚­ãƒ£ãƒ³ãƒã‚¹çŠ¶æ…‹ */
    #three-canvas.full-canvas {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      display: block;
      z-index: 0;
      background: transparent;
    }
    #three-canvas.intro-canvas {
      position: relative;
      /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚ã¯ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã‚’è‡ªå‹•ã«ã—ã¦è¦ªè¦ç´ å†…ã§ä¸­å¤®ã«é…ç½®ã™ã‚‹ */
      width: auto;
      height: auto;
      max-width: 100%;
      max-height: 100%;
      display: block;
      margin: auto;
      z-index: 0;
      background: transparent;
      border-radius: 6px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.6);
    }
  </style>
  <style>
    /* LED-style marquee (é›»å…‰æ²ç¤ºæ¿é¢¨) */
    .led-marquee {
      overflow: hidden;
      background: rgba(0,0,0,0.85);
      color: #00ff66;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 18px;
      line-height: 1;
      box-shadow: 0 4px 18px rgba(0,0,0,0.6);
      display: block;
      width: 100%;
      box-sizing: border-box;
      -webkit-font-smoothing: antialiased;
      font-variant-ligatures: none;
    }
    .led-marquee__inner {
      
      display: grid;
      grid-template-rows: repeat(3, 1fr);
      align-items: center;
      gap: 0; /* å˜ä¸€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’1å›æµã™ãŸã‚ gap ã¯ä¸è¦ */
      white-space: nowrap;
      will-change: transform;
      animation-timing-function: linear;

      /* animation-name / duration ã¯ JS ã§è¨­å®š */
    }
    .led-marquee__text { display: inline-block; }
    .led-marquee:hover .led-marquee__inner { animation-play-state: paused; }
    
    @keyframes marquee {
      from { transform: translateX(var(--marquee-from, 100%)); }
      to   { transform: translateX(var(--marquee-to, -100%)); }
    }

    /* å·¦å›ºå®šè¡¨ç¤ºï¼ˆæµã•ãªã„è¡Œï¼‰ */
    .led-row.static .led-marquee__text{
      transform: none !important;
    }

    /* static ã®æ™‚ã¯ inner å…¨ä½“ã®ã‚¢ãƒ‹ãƒ¡ã‚’ä½¿ã‚ãªã„ã®ã§ã€è¡Œå˜ä½ã§åˆ¶å¾¡ã™ã‚‹ */
    .led-row .led-marquee__text{
      will-change: transform;
    }

    @keyframes marqueeRow {
      from { transform: translateX(var(--row-from, 100%)); }
      to   { transform: translateX(var(--row-to, -100%)); }
    }

    .led-color-white  { color:#ffffff; text-shadow:0 0 8px rgba(255,255,255,.8); }
    .led-color-green  { color:#00ff66; text-shadow:0 0 8px rgba(0,255,102,.8); }
    .led-color-orange { color:#ffb347; text-shadow:0 0 8px rgba(255,77,77,.8); }
    .led-color-red    { color:#ff4d4d; text-shadow:0 0 8px rgba(255,77,77,.8); }
    .led-color-blue   { color:#7be6ff; text-shadow:0 0 8px rgba(123, 143, 255, 0.8); }
    .led-color-yellow { color:#ffe35a; text-shadow:0 0 8px rgba(255,227,90,.8); }
    .led-color-pink   { color:#ff69b4; text-shadow:0 0 8px rgba(255,105,180,.8); }

    .led-row.theme-orange .led-marquee__text { color:#ff6200; text-shadow:0 0 10px rgba(255,77,77,.8); }
    .led-row.theme-green .led-marquee__text { color:#00ff66b8; text-shadow:0 0 10px rgba(0, 255, 102, 0.507); }
    .led-row.theme-alert .led-marquee__text { color:#ff4d4d; text-shadow:0 0 10px rgba(255,77,77,.8); }
    .led-row.theme-info  .led-marquee__text { color:#7be6ff; text-shadow:0 0 10px rgba(123,230,255,.7); }
    .led-row.theme-local .led-marquee__text { color:#ffe35a; text-shadow:0 0 10px rgba(255,227,90,.7); }


  </style>
    <style>
      /* Welcome overlay: disable internal scrolling so page scroll controls navigation */
        #welcome { overflow: visible; -webkit-overflow-scrolling: auto; }
        .welcome-content { max-height: none; overflow: visible; -webkit-overflow-scrolling: auto; }
    </style>
  <style>
    /* æ“ä½œèª¬æ˜ãƒ‘ãƒãƒ« */
    #instructions-panel {
      position: fixed;
      top: 80px;
      /* width: 320px; */
      max-width: calc(100% - 32px);
      max-height: calc(80vh);
      overflow: auto;
      background: rgba(255,255,255,0.95);
      color: #111;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.2);
      z-index: 9999;
      display: none;
      font-size: 14px;
      line-height: 1.5;
    }
    #show-instructions-btn {
      position: fixed;
      right: 12px;
      top: 20px;
      z-index: 10000;
      padding: 8px 12px;
      background: rgba(0,0,0,0.6);
      color: white;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      backdrop-filter: blur(4px);
      touch-action: manipulation;
    }
  </style>

  <style>
    /* Canvas ä¸Šã«é‡ã­ã‚‹ UI ç”¨ã‚³ãƒ³ãƒ†ãƒŠ */
    #three-ui {
      position: absolute; /* intro æ™‚ã¯ intro-wrapper å†…ã§ç›¸å¯¾é…ç½® */
      inset: 0;
      pointer-events: none; /* å­è¦ç´ ã®ã¿åå¿œã•ã›ã‚‹ */
      z-index: 2;
    }
    /* canvas å†…ã«ç§»å‹•ã—ãŸ UI è¦ç´ ã¯ã“ã‚Œã‚’ä»˜ä¸ã—ã¦æ“ä½œå¯èƒ½ã«ã™ã‚‹ */
    .canvas-ui { pointer-events: auto; }
  </style>
  <style>
    /* Dragging: prevent text selection */
    body.dragging, body.dragging * {
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
  </style>
  <style>
    /* UiGroup tooltip */
    #UiGroup { position: fixed; }
    .ui-tooltip {
      position: absolute;
      z-index: 2147483647;
      padding: 6px 8px;
      background: rgba(0,0,0,0.85);
      color: #fff;
      font-size: 11px;
      line-height: 1.3;
      border-radius: 6px;
      white-space: nowrap;
      box-shadow: 0 4px 14px rgba(0,0,0,0.35);
      pointer-events: none;
      opacity: 0;
      transform: translateY(2px);
      transition: opacity 120ms ease, transform 120ms ease;
    }
    .ui-tooltip.is-visible {
      opacity: 1;
      transform: translateY(0);
    }
  </style>

  <style>
    /* æ‹¡å¤§è¡¨ç¤ºæ™‚ã« canvas ã®ã¿è¡¨ç¤ºã™ã‚‹ã‚¯ãƒ©ã‚¹ */
    body.only-canvas > * { display: none !important; }
    body.only-canvas #three-canvas {
      display: block !important;
      position: fixed !important;
      inset: 0 !important;
      width: 100% !important;
      height: 100% !important;
      z-index: 2147483646 !important;
      background: transparent !important;
    }
    /* ãŸã ã— three-uiï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹ä¸Šã® UIï¼‰ã¯è¡¨ç¤ºã™ã‚‹ */
    body.only-canvas #three-ui { display: block !important; position: fixed !important; inset: 0 !important; z-index: 2147483647 !important; pointer-events: auto !important; }
    body.only-canvas .canvas-ui { pointer-events: auto !important; }
  </style>

  <!-- Google Analytics è¨­å®š é–²è¦§æ•°ã®æ¸¬å®šç”¨ã§ã™ã€‚-->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-B8X9Y12345"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-E7Z2FM74H9');
  </script>
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.169.0/build/three.module.js"
    }
  }
  </script>
</head>
<body>
<!--   
  <button id="speed-up" class="no-touch-highlight" style="position: fixed; left: 20px; bottom: 200px; width: 60px; height: 60px; font-size: 24px; border-radius: 30px; z-index: 20; opacity: 0.3;">â–¶ï¸â–·</button>

  <button id="speed-down" class="no-touch-highlight" style="position: fixed; left: 95px; bottom: 200px; width: 60px; height: 60px; font-size: 24px; border-radius: 30px; z-index: 20; opacity: 0.3;">â—€ï¸â—</button>
  
  <button id="btn-up" class="no-touch-highlight" style="position: fixed; left: 20px; bottom: 120px; width: 60px; height: 60px; font-size: 24px; border-radius: 30px; z-index: 20; opacity: 0.3;">ğŸ”º</button>
  
  <button id="btn-down" class="no-touch-highlight" style="position: fixed; left: 20px; bottom: 40px; width: 60px; height: 60px; font-size: 24px; border-radius: 30px; z-index: 20; opacity: 0.3;">ğŸ”»</button> -->
  <style>
    .section {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.6);
      z-index: 200;
      min-height: 80vh; /* å°‘ã—çŸ­ã‚ã«ã—ã¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–“ã®ä½™ç™½ã‚’æ¸›ã‚‰ã™ */
      padding: 12px 0 0 0;  /* ä¸Šæ–¹å‘ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã®ã¿ã«ã—ã¦ä¸‹ä½™ç™½ã‚’ç„¡ãã™ */
      margin: 0; /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–“ã®å¤–å´ã®ä½™ç™½ã‚’ç„¡ãã™ */
    }

    /* é€£ç¶šã™ã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–“ã®éš™é–“ã‚’ã‚¼ãƒ­ã«ã™ã‚‹ */
    .section + .section { margin-top: 0; padding-top: 0; }

    /* Welcome ã®å†…å´ä½™ç™½ã‚‚è©°ã‚ã‚‹ */
    .welcome-content { margin-bottom: 0; padding-bottom: 0; }

    .control-button {
    position: absolute;
      width: 60px;
      height: 60px;
      font-size: 24px;
      border: none;
      border-radius: 30px;
      background-color: rgba(255, 255, 255, 0.2); /* é€éã£ã½ã„ */
      color: white;
      z-index: 20;
      backdrop-filter: blur(4px); /* iOSã£ã½ã„ã‚¬ãƒ©ã‚¹æ„Ÿ */
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      transition: all 0.1s ease-in-out;
      
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
    }

  .control-square-button {
    position: relative;
    width: 400px;
    height: 40px;
    font-size: 24px;
    border: none;
    border-radius: 4px; /* â† å››è§’ã£ã½ã„è§’ä¸¸ï¼ˆå®Œå…¨ã«å››è§’ãªã‚‰ 0 ã«ï¼‰ */
    background-color: rgba(255, 255, 255, 0.2);
    color: white;
    z-index: 20;
    backdrop-filter: blur(4px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    transition: all 0.1s ease-in-out;

    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
  }
  .log-control-square-button {
    position: relative;
    width: 800px;
    height: 400px;
    font-size: 24px;
    border: none;
    border-radius: 4px; /* â† å››è§’ã£ã½ã„è§’ä¸¸ï¼ˆå®Œå…¨ã«å››è§’ãªã‚‰ 0 ã«ï¼‰ */
    background-color: rgba(255, 255, 255, 0.2);
    color: white;
    z-index: 20;
    backdrop-filter: blur(4px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    transition: all 0.1s ease-in-out;

    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
  }

  /* ãƒ›ãƒãƒ¼ï¼ˆãƒã‚¦ã‚¹ã‚’ä¹—ã›ãŸã¨ãï¼‰ã§æš—ãã™ã‚‹ */
  .control-button:hover {
    filter: brightness(85%);
    cursor: pointer;
  }

  /* ã‚¯ãƒªãƒƒã‚¯ä¸­ï¼ˆæŠ¼ã—ã¦ã‚‹æœ€ä¸­ï¼‰ã§ã•ã‚‰ã«æš—ãã™ã‚‹ */
  .control-button:active {
    filter: brightness(70%);
  }

  /* ã‚¢ã‚¤ã‚³ãƒ³ã®é‡ã­ãƒ©ãƒƒãƒ‘ãƒ¼ */
  .icon-wrapper {
    position: relative;
    display: flex;              /* ä¸­å¤®å¯„ã›ç”¨ */
    align-items: center;        /* ç¸¦ä¸­å¤® */
    justify-content: center;    /* æ¨ªä¸­å¤® */
    width: 2em;                 /* ãƒœã‚¿ãƒ³ã«åˆã‚ã›ã¦å¤§ãã‚ã« */
    height: 2em;
    }

  /* è–„ã„èƒŒæ™¯è¨˜å· */
  .background-icon {
    position: absolute;
    color: rgba(0, 0, 0, 0.5);
    font-size: 1.5em;
  }
  /* æ¿ƒã„å‰é¢è¨˜å· */
  .foreground-icon {
    position: absolute;
    color: black;
    font-size: 1.3em;
  }
  
  .credits-footer {
    position: relative;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255,255,255,0.9);
    padding: 6px 12px;
    font-size: 12px;
    text-align: center;
    z-index: 9999;
    box-shadow: 0 -1px 6px rgba(0,0,0,0.12);
  }
  .credits-footer a { color: #0645ad; text-decoration: underline; }

  /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .circle-ctrl-area {
    position: absolute;
    border-radius: 50%;
    background: rgba(255,255,255,0.95);
    background: rgba(0,0,0,0.5);
    border: 2px solid #333;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    transform: translate(-50%, -50%); /* left/top ã‚’ä¸­å¿ƒã«ã™ã‚‹ */
    display: flex;
    align-items: center;
    justify-content: center;
    user-select: none;
    touch-action: none;
    cursor: grab;
    pointer-events: auto;
  }
  /* .circle-ctrl-area { cursor: grabbing; } */

  .circle-ctrl {
    position: absolute;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: rgba(0,0,0,0.5);
    border: 2px solid #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    transform: translate(-50%, -50%); /* left/top ã‚’ä¸­å¿ƒã«ã™ã‚‹ */
    display: flex;
    align-items: center;
    justify-content: center;
    user-select: none;
    touch-action: none;
    cursor: grab;
    pointer-events: auto;
  }
  /* .circle-ctrl:active { cursor: grabbing; } */
  #UiGroup {
    position: relative; /* ã“ã“ã‚’åŸºæº–ã«ã™ã‚‹ */
    width: 10%;
    height: 590px;
    border: 1px solid rgba(221, 221, 221, 0.2); /* é€æ˜åº¦ 0.5 (=50%) */
  }
  #UiGroup button {
    position: absolute; /* top ãŒåŠ¹ãã‚ˆã†ã«ã™ã‚‹ */
    left: 0;
    width: 72px;
    height: 28px;
  }

  .edit-guide {
    display: grid;
    grid-template-columns: 1fr;
    gap: 14px;
  }
  .edit-guide .guide-block {
    background: rgba(0,0,0,0.35);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 10px;
    padding: 12px;
  }
  .edit-guide .guide-block h3 {
    margin: 0 0 8px 0;
    font-size: 15px;
  }
  .edit-guide .guide-block ul {
    margin: 0 0 0 18px;
    line-height: 1.7;
  }

  #guide-window {
    position: fixed;
    right: 20px;
    bottom: 24px;
    width: 340px;
    max-width: calc(100% - 40px);
    background: rgba(255, 255, 255, 0.92);
    color: #111;
    border-radius: 14px;
    box-shadow: 0 10px 28px rgba(0,0,0,0.25);
    padding: 14px;
    z-index: 10001;
    display: none;
    pointer-events: auto;
    backdrop-filter: blur(6px);
  }
  #guide-window .guide-title {
    font-size: 14px;
    letter-spacing: 0.06em;
    font-weight: 700;
    margin: 0 0 10px;
  }
  #guide-window .guide-sub {
    font-size: 11px;
    color: #555;
    margin: 0 0 12px;
  }
  #guide-window .guide-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 8px;
  }
  #guide-window .guide-card {
    border: 1px solid rgba(0,0,0,0.08);
    border-radius: 10px;
    padding: 10px;
    background: rgba(250, 250, 250, 0.9);
    min-height: 62px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 6px;
  }
  #guide-window button.guide-card {
    appearance: none;
    border: 1px solid rgba(0,0,0,0.08);
    border-radius: 10px;
    padding: 10px;
    background: rgba(250, 250, 250, 0.95);
    min-height: 62px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 6px;
    text-align: left;
    cursor: pointer;
  }
  #guide-window button.guide-card:active {
    transform: translateY(1px);
  }
  #guide-window button.guide-card:focus-visible {
    outline: 2px solid rgba(0, 0, 0, 0.5);
    outline-offset: 2px;
  }
  #guide-window .guide-card .guide-name {
    font-size: 12px;
    font-weight: 700;
  }
  #guide-window .guide-card .guide-preview {
    width: 100%;
    height: 40px;
    border-radius: 6px;
    background: linear-gradient(180deg, rgba(235, 242, 255, 0.9), rgba(245, 250, 255, 0.9));
    border: 1px solid rgba(120, 150, 190, 0.2);
    overflow: hidden;
  }
  #guide-window .guide-card .guide-preview svg {
    width: 100%;
    height: 100%;
    display: block;
  }
  #guide-window .guide-card .guide-preview path {
    fill: none;
    stroke: #2f5fae;
    stroke-width: 3;
    stroke-linecap: round;
    stroke-linejoin: round;
  }
  #guide-window .guide-card .guide-meta {
    font-size: 10px;
    color: #777;
  }

</style>
  

  <!-- Welcome overlay with a scaled-down canvas preview -->
  <section id="welcome" class="section">
      <div class="welcome-content" style="width: 80%; max-width: 960px; background: rgba(255,255,255,0.06); padding: 24px; border-radius: 12px; backdrop-filter: blur(6px);"> 
      <div class="led-marquee" aria-label="announcement">

        <div class="led-marquee__inner" id="led-marquee-inner">
          <div class="led-row" data-row="0"><span class="led-marquee__text"></span></div>
          <div class="led-row" data-row="1"><span class="led-marquee__text"></span></div>
          <div class="led-row" data-row="2"><span class="led-marquee__text"></span></div>
        </div>

      </div>
      <div style="display:flex; gap:16px; align-items:center; flex-wrap:wrap;">
        <div id="intro-wrapper" style="flex: 1 1 480px; max-width: 640px; background: rgba(0,0,0,0.4); padding: 8px; border-radius: 8px; display:flex; align-items:center; justify-content:center; position: relative;">
          <canvas id="three-canvas"></canvas>
          <!-- three-ui: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚ã¯ã“ã“ã«ãƒœã‚¿ãƒ³ç¾¤ã‚’è¡¨ç¤º -->
          <div id="three-ui">
            <div class="canvas-ui">
              <button id="speed-up" class="control-button" style="right: 20px; bottom: 200px;">â—€ï¸â—</button>
              <button id="speed-down" class="control-button" style="right: 95px; bottom: 200px;">â–¶ï¸â–·</button>
              <button id="btn-up" class="control-button" style="right: 160px; bottom: 150px;">ğŸ”º</button>
              <button id="btn-down" class="control-button" style="right: 160px; bottom: 70px;">ğŸ”»</button>

              <button id="controller-area" class="circle-ctrl-area" style="left: 160px; bottom: 60px; width: 80px; height: 80px"></button>
              <button id="controller" class="circle-ctrl" style="left: 160px; bottom: 110px; width: 30px; height: 30px"></button>

              <button id="log" class="control-button" style="right: 20px; top: 40px;">ğŸ“¤</button>

              <div id="UiGroup" style="position: fixed; top: 140px; left: 20px; z-index: 100;">
                <button id = 'see' style = 'top: 10px;' > ğŸ¦ </button>
                <button id = 'edit' style = 'top: 40px;' > ğŸ› ï¸ </button>
                <button id = 'rail' style = 'top: 70px; left:10px;' > ğŸ›¤ï¸ </button>
                <button id = 'new' style = 'top: 100px; left:20px;' > + </button>
                <button id = 'move' style = 'top: 130px; left:20px;' > ğŸ’« </button>
                <button id = 'x_z' style = 'top: 160px; left:30px;' > â¤® </button>
                <button id = 'y' style = 'top: 190px; left:30px;' > â‡¡ </button>
                <button id = 'structure' style = 'top: 130px; left:80px;' > ğŸŒ‰</button>
                <button id = 'new/2' style = 'top: 160px; left:90px;' > + </button>
                <button id = 'construction' style = 'top: 190px; left:90px;' > ğŸ—ï¸ </button>

              </div>

              <!-- ãƒ©ãƒ³ãƒ€ãƒ ç«‹ä½“äº¤å·®ãƒœã‚¿ãƒ³ã¯éè¡¨ç¤ºã«å¤‰æ›´ -->

              <div id="frontViewButtons" style="position: fixed; top: 20px; right: 20px; z-index: 100;">
                <button class="frontViewBtn" data-train="1">1ç•ªç·š</button>
                <button class="frontViewBtn" data-train="2">2ç•ªç·š</button>
                <button class="frontViewBtn" data-train="3">3ç•ªç·š</button>
                <button class="frontViewBtn" data-train="4">4ç•ªç·š</button>
              </div>

              <button id="toggle-daynight" style="position: absolute; top: 70px; left: 20px; z-index: 10; padding: 10px 15px; font-size: 16px; border-radius: 8px;">ğŸŒ™ å¤œã«ã™ã‚‹</button>

              <div id="save-buttons" style="position: absolute; left: 20px; top: 20px; display: flex; gap: 8px; z-index: 10;">
                <button id="save-track-data" class="control-square-button" style="padding: 10px; font-size: 14px; backdrop-filter: blur(4px);">è»Œé“ä¿å­˜</button>
                <button id="save-structure-data" class="control-square-button" style="padding: 10px; font-size: 14px; backdrop-filter: blur(4px);">ãƒ”ãƒ³ä¿å­˜</button>
              </div>

              <button id = "logwindow" class="log-control-square-button" style="position: absolute; left: 130px; top: 20px; padding: 10px; font-size: 14px; color: #000; z-index: 10; backdrop-filter: blur(4px);">ãƒ¢ãƒã‚¤ãƒ«å‡ºåŠ›ç”¨</button>
              
              <button id="show-instructions-btn">æ“ä½œèª¬æ˜</button>

              <div id="instructions-panel" role="region" aria-label="æ“ä½œèª¬æ˜">
                <h3 style="margin-top:0;">æ“ä½œèª¬æ˜</h3>
                <ul>
                  [è¦–ç‚¹] ç”»é¢ä¸Šã‚’ã‚¹ãƒ©ã‚¤ãƒ‰/ãƒ‰ãƒ©ãƒƒã‚°ã§è¦–ç‚¹ã‚’å›è»¢ãƒ»ç§»å‹•ã—ã¾ã™ã€‚<br>
                  [ç§»å‹•] å·¦ä¸‹ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ© åˆã¯ A.S.D.W ã‚­ãƒ¼ã§ å‰å¾Œå·¦å³ã«ç§»å‹•ã§ãã¾ã™ã€‚<br>
                  [è¡¨ç¤ºåˆ‡æ›¿] å³ä¸Šã®ãƒœã‚¿ãƒ³ã§åˆ—è»Šãƒ“ãƒ¥ãƒ¼ç­‰ã‚’åˆ‡æ›¿ãˆã¾ã™ã€‚<br>
                  [ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³] ã€Œè¡¨ç¤ºã‚’é–‹å§‹ã™ã‚‹ã€ã§ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¡¨ç¤ºã«åˆ‡æ›¿ã€å†åº¦ã€Œæ“ä½œèª¬æ˜ã€ã‚’é–‰ã˜ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«æˆ»ã›ã¾ã™ã€‚
                </ul>
                <p style="margin-bottom:0;">â€» ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ç”»é¢ã‚’é•·æŠ¼ã—ã™ã‚‹ã¨ã‚ºãƒ¼ãƒ ã—ã¾ã™ã€‚</p>
              </div>

              <div id="rotation-panel" role="region" aria-label="å›è»¢ãƒ‘ãƒãƒ«" style="position: fixed; right: 20px; top: 120px; width: 220px; padding: 12px; background: rgba(255,255,255,0.92); border-radius: 10px; box-shadow: 0 8px 20px rgba(0,0,0,0.25); z-index: 10002; display: none; pointer-events: auto;">
                <div style="font-size: 12px; font-weight: 700; margin-bottom: 8px;">Rotation</div>
                <div style="display: grid; grid-template-columns: 1fr; gap: 6px;">
                  <label style="font-size: 11px; color: #b23b3b;">X (deg)
                    <input id="rotation-input-x" type="number" step="1" placeholder="0" style="width: 100%; color: #b23b3b; border: 1px solid #e3b5b5;">
                  </label>
                  <label style="font-size: 11px; color: #2f8f57;">Y (deg)
                    <input id="rotation-input-y" type="number" step="1" placeholder="0" style="width: 100%; color: #2f8f57; border: 1px solid #bfe3c9;">
                  </label>
                  <label style="font-size: 11px; color: #2f6fb8;">Z (deg)
                    <input id="rotation-input-z" type="number" step="1" placeholder="0" style="width: 100%; color: #2f6fb8; border: 1px solid #bcd5ee;">
                  </label>
                </div>
                <button id="rotation-apply" style="margin-top: 8px; width: 100%; padding: 6px 8px;">é©ç”¨</button>
                <pre id="rotation-selection-info" style="margin-top: 8px; max-height: 180px; overflow: auto; padding: 6px; border-radius: 6px; background: rgba(20,20,20,0.06); font-size: 10px; line-height: 1.45; white-space: pre-wrap;">é¸æŠç‚¹: 2ç‚¹ä»¥ä¸Šã§æƒ…å ±ã‚’è¡¨ç¤º</pre>
              </div>

              <div id="guide-window" role="region" aria-label="é…ç½®ã‚¬ã‚¤ãƒ‰">
                <div class="guide-title">GUIDE SHELF</div>
                <div class="guide-sub">é…ç½®ã™ã‚‹ç‰©ä½“ã‚’ä¸¦ã¹ã‚‹æ£šï¼ˆä»®ï¼‰</div>
                <div class="guide-grid">
                  <button class="guide-card" data-guide-template="curve_s">
                    <div class="guide-preview" aria-hidden="true">
                      <svg viewBox="0 0 100 40" preserveAspectRatio="none">
                        <path d="M4 26 C20 4, 38 4, 50 20 C62 36, 80 36, 96 14" />
                      </svg>
                    </div>
                    <div class="guide-name">ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ A</div>
                    <div class="guide-meta">Så­—è»Œé“ï¼ˆä»®ï¼‰</div>
                  </button>
                  <button class="guide-card" data-guide-template="curve_l">
                    <div class="guide-preview" aria-hidden="true">
                      <svg viewBox="0 0 100 40" preserveAspectRatio="none">
                        <path d="M8 30 L64 30 Q82 30, 82 12" />
                      </svg>
                    </div>
                    <div class="guide-name">ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ B</div>
                    <div class="guide-meta">Lå­—è»Œé“ï¼ˆä»®ï¼‰</div>
                  </button>
                  <button class="guide-card" data-guide-template="curve_u">
                    <div class="guide-preview" aria-hidden="true">
                      <svg viewBox="0 0 100 40" preserveAspectRatio="none">
                        <path d="M10 10 L10 26 Q10 34, 22 34 L78 34 Q90 34, 90 26 L90 10" />
                      </svg>
                    </div>
                    <div class="guide-name">ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ C</div>
                    <div class="guide-meta">Uå­—è»Œé“ï¼ˆä»®ï¼‰</div>
                  </button>
                  <button class="guide-card" data-guide-template="curve_straight">
                    <div class="guide-preview" aria-hidden="true">
                      <svg viewBox="0 0 100 40" preserveAspectRatio="none">
                        <path d="M6 20 L94 20" />
                      </svg>
                    </div>
                    <div class="guide-name">ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ D</div>
                    <div class="guide-meta">ç›´ç·šè»Œé“ï¼ˆä»®ï¼‰</div>
                  </button>
                  <button class="guide-card" data-guide-template="curve_square">
                    <div class="guide-preview" aria-hidden="true">
                      <svg viewBox="0 0 100 40" preserveAspectRatio="none">
                        <path d="M18 8 L82 8 L82 32 L18 32 Z" />
                      </svg>
                    </div>
                    <div class="guide-name">ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ E</div>
                    <div class="guide-meta">æ­£æ–¹å½¢è»Œé“ï¼ˆä»®ï¼‰</div>
                  </button>
                  <button class="guide-card" data-guide-template="curve_circle">
                    <div class="guide-preview" aria-hidden="true">
                      <svg viewBox="0 0 100 40" preserveAspectRatio="none">
                        <path d="M50 8 C67 8, 82 13, 82 20 C82 27, 67 32, 50 32 C33 32, 18 27, 18 20 C18 13, 33 8, 50 8 Z" />
                      </svg>
                    </div>
                    <div class="guide-name">ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ F</div>
                    <div class="guide-meta">å††å½¢è»Œé“ï¼ˆä»®ï¼‰</div>
                  </button>
                </div>
              </div>

            </div>
          </div>
        </div>
        <div style="flex: 1 1 260px; min-width: 220px;">
          <div id="preview-feature" style="margin:12px 0; padding:16px; background: rgba(255,255,255,0.04); border-radius:10px; text-align:center;">
            <h2 style="margin:0 0 8px 0; font-size:18px;">æ“ä½œèª¬æ˜</h2>
            <ul>
                  [è¦–ç‚¹] ç”»é¢ä¸Šã‚’ã‚¹ãƒ©ã‚¤ãƒ‰/ãƒ‰ãƒ©ãƒƒã‚°ã§è¦–ç‚¹ã‚’å›è»¢ãƒ»ç§»å‹•ã—ã¾ã™ã€‚<br>
                  [ç§»å‹•] å·¦ä¸‹ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ© åˆã¯ A.S.D.W ã‚­ãƒ¼ã§ å‰å¾Œå·¦å³ã«ç§»å‹•ã§ãã¾ã™ã€‚<br>
                  [è¡¨ç¤ºåˆ‡æ›¿] å³ä¸Šã®ãƒœã‚¿ãƒ³ã§åˆ—è»Šãƒ“ãƒ¥ãƒ¼ç­‰ã‚’åˆ‡æ›¿ãˆã¾ã™ã€‚<br>
                  [ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³] ã€Œè¡¨ç¤ºã‚’é–‹å§‹ã™ã‚‹ã€ã§ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¡¨ç¤ºã«åˆ‡æ›¿ã€å†åº¦ã€Œæ“ä½œèª¬æ˜ã€ã‚’é–‰ã˜ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«æˆ»ã›ã¾ã™ã€‚
            </ul>
            <p style="margin-bottom:0;">â€» ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ç”»é¢ã‚’é•·æŠ¼ã—ã™ã‚‹ã¨ã‚ºãƒ¼ãƒ ã—ã¾ã™ã€‚</p>

          </div>
        </div>
      </div>
      <div style="flex: 1 1 260px; min-width: 220px;">
        <div id="preview-feature" style="margin:12px 0; padding:16px; background: rgba(255,255,255,0.04); border-radius:10px; text-align:center;">
          <h2 style="margin:0 0 8px 0; font-size:18px;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ æ“ä½œãƒ‘ãƒãƒ«</h2>
          <p style="margin:0 0 12px 0; opacity:0.9;">ã“ã“ã‹ã‚‰ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¡¨ç¤ºã«åˆ‡æ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚</p>
          <div style="display:flex; gap:10px; justify-content:center;">
            <button id="preview-start" style="padding:14px 20px; font-size:18px; border-radius:10px; background:#0078d4; color:#fff; border:none;">è¡¨ç¤ºã‚’é–‹å§‹ã™ã‚‹</button>
            <button id="preview-skip" style="padding:12px 16px; font-size:16px; border-radius:10px; background:rgba(0,0,0,0.6); color:#fff; border:none;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã¾ã¾é–‰ã˜ã‚‹</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section id="operation" class="section">
    <div style="width: 80%; max-width: 960px; background: rgba(255,255,255,0.06); padding: 24px; border-radius: 12px; backdrop-filter: blur(6px); color: white;"> 
      <h1 style="margin-top: 0;">ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®èª¬æ˜</h1>
      
      <p>ã“ã®ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€ç·šè·¯ã®å½¢çŠ¶ã®ç·¨é›†ã€æ§‹é€ ç‰©ã®é…ç½®ã‹ã‚‰ä½œæˆã¾ã§è¡Œãˆã¾ã™ã€‚<br>ä»¥ä¸‹ã¯ <strong>edit</strong> ã¨ <strong>creat</strong> ã§åˆ†ã‘ãŸèª¬æ˜ã§ã™ã€‚</p>

      <div class="edit-guide">
        <div class="guide-block">
          <h3>editï¼ˆç·¨é›†ï¼‰/ è»Œé“ã®ç·¨é›†ã‚„ã€æ©‹ãƒ»ãƒˆãƒ³ãƒãƒ«ã¨ã„ã£ãŸæ§‹é€ ç‰©ã®ç”Ÿæˆã‚’ç°¡å˜ã«è¡Œãˆã‚‹ãƒ¢ãƒ¼ãƒ‰</h3>
          <ul>
            <li><strong>ğŸ› ï¸ edit</strong>: ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®é–‹å§‹ã€‚ä»¥é™ã®ã‚¿ãƒƒãƒ—/ã‚¯ãƒªãƒƒã‚¯ã¯ç·¨é›†å‹•ä½œã«ãªã‚Šã¾ã™ã€‚</li>
            <li><strong>ğŸ›¤ï¸ rail</strong>: è»Œé“ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã€‚`new` ã§åˆ¶å¾¡ç‚¹è¿½åŠ ã€`move` ã§ç‚¹ç§»å‹•ã€`x_z`/`y` ã§ç§»å‹•å¹³é¢ã‚’åˆ‡æ›¿ã€‚</li>
            <li><strong>ğŸŒ‰ structure â†’ new</strong>: è»Œé“ä¸Šã«ãƒ”ãƒ³ã‚’è¿½åŠ ã€‚</li>
            <li><strong>ğŸ—ï¸ construction</strong>: è¿½åŠ ã—ãŸãƒ”ãƒ³ã‚’é¸æŠã—ã¦ bridge / elevated / wall / floor / pillar / rib_bridge ã‚’ç”Ÿæˆã€‚</li>
            <li><strong>è»Œé“ä¿å­˜ / ãƒ”ãƒ³ä¿å­˜</strong>: ç¾åœ¨ã®è»Œé“ãƒ»ãƒ”ãƒ³é…ç½®ã‚’ä¿å­˜ã—ã¾ã™ã€‚</li>
          </ul>
        </div>

        <div class="guide-block">
          <h3>creatï¼ˆä½œæˆï¼‰/ é‰„éª¨ã‚„æ¿æã€é›»å…‰æ²ç¤ºæ¿ãªã©ã‚’è‡ªç”±ã«é…ç½®ã—ã€é§…ã‚„æ§‹ç¯‰ç‰©ã‚’ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã™ã‚‹ãƒ¢ãƒ¼ãƒ‰</h3>
          <ul>
            <li><strong>creat â†’ view</strong>: ã‚¯ãƒªã‚¨ã‚¤ãƒˆç³»ã®è¡¨ç¤ºåˆ‡æ›¿ã€‚</li>
            <li><strong>creat â†’ add_point</strong>: ç‚¹ã®è¿½åŠ ãƒ¢ãƒ¼ãƒ‰ã€‚ã‚¿ãƒƒãƒ—ã§ç‚¹ã‚’ç”Ÿæˆã—ã€è»Œé“ã¨ã—ã¦çµã³ã¾ã™ã€‚</li>
            <li><strong>add_point â†’ y_add</strong>: é«˜ã•æ–¹å‘ï¼ˆYï¼‰ã ã‘ã‚’ç§»å‹•ã™ã‚‹è£œåŠ©ãƒ¢ãƒ¼ãƒ‰ã€‚</li>
            <li><strong>add_point â†’ template</strong>: ã‚¬ã‚¤ãƒ‰æ£šã‚’è¡¨ç¤ºã€‚S/L/U/ç›´ç·šã®ã‚¬ã‚¤ãƒ‰è»Œé“ã‚’é…ç½®ã§ãã¾ã™ã€‚</li>
            <li><strong>add_point â†’ guide â†’ add</strong>: ã‚¬ã‚¤ãƒ‰æ£šã‚’è¡¨ç¤ºã€‚S/L/U/ç›´ç·šã®ã‚¬ã‚¤ãƒ‰è»Œé“ã‚’é…ç½®ã§ãã¾ã™ã€‚</li>
            <li><strong>template / add ã®ãƒ›ãƒãƒ¼</strong>: ã‚¬ã‚¤ãƒ‰è»Œé“ã«ãƒ›ãƒãƒ¼ä¸­ã¯ã‚¬ã‚¤ãƒ‰è‰²ãŒå¤‰åŒ–ã—ã€ãƒ”ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li>
            <li><strong>add_point ã®ã‚¬ã‚¤ãƒ‰é…ç½®</strong>: ã‚¬ã‚¤ãƒ‰è»Œé“ã«å½“ãŸã£ã¦ã„ã‚‹é–“ã¯ã€ãã®è»Œé“ä¸Šã«ç‚¹ã‚’æ‰“ã¦ã¾ã™ã€‚</li>
            <li><strong>creat â†’ construction</strong>: è¿½åŠ ã—ãŸç‚¹ã‚’é¸æŠã—ã¦ `pillar` / `rite` ãªã©ã®éƒ¨æã‚’é¸æŠã—ã¦ç”Ÿæˆã€‚</li>
            <li><strong>move_point</strong>: æ—¢å­˜ã®ç‚¹ã‚’ç§»å‹•ã€‚`x_z_sf`/`y_sf` ã§ç§»å‹•å¹³é¢åˆ‡æ›¿ã€‚</li>
            <li><strong>rotation</strong>: è¤‡æ•°ç‚¹ã‚’é¸æŠã™ã‚‹ã¨ä¸­å¿ƒã«ã‚®ã‚ºãƒ¢è¡¨ç¤ºã€‚ãƒªãƒ³ã‚°ãƒ‰ãƒ©ãƒƒã‚°ã§ç‚¹ã®ä½ç½®ã ã‘å›è»¢ã€‚</li>
            <li><strong>rotation panel</strong>: X/Y/Z ã®è§’åº¦ã‚’å…¥åŠ›ã—ã¦çµ¶å¯¾è§’åº¦ã§å›è»¢ã€‚è¡¨ç¤ºã¯ç¾åœ¨è§’åº¦ã‚’è–„ãè¡¨ç¤ºã€‚</li>
          </ul>
        </div>
      </div>

      <p style="margin: 0 0 12px 0; opacity:0.85;">ãƒã‚¤ãƒ³ãƒˆ: `add_point` ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã¨ã‚¬ã‚¤ãƒ‰åˆ¤å®šã‚„ã‚¬ã‚¤ãƒ‰ãƒãƒ¥ãƒ¼ãƒ–ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚`move` ä¸­ã¯ã‚¬ã‚¤ãƒ‰ãƒ›ãƒãƒ¼ã¯åœæ­¢ã—ã¾ã™ã€‚</p>
      
      <div style="display:flex; gap:16px; align-items:center; flex-wrap:wrap;">
        <div id="intro-wrapper" style="flex: 1 1 480px; max-width: 640px; background: rgba(0,0,0,0.4); padding: 8px; border-radius: 8px; display:flex; align-items:center; justify-content:center; position: relative;">
          <canvas id="three-canvas"></canvas>
          <!-- three-ui: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚ã¯ã“ã“ã«ãƒœã‚¿ãƒ³ç¾¤ã‚’è¡¨ç¤º -->
        </div>
      <p style="opacity:0.8; font-size:13px; margin-top:12px;">â€» ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ã‚¿ãƒƒãƒæ“ä½œã€ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§ã¯ãƒã‚¦ã‚¹ã§æ“ä½œã§ãã¾ã™ã€‚</p>
    </div>
  </section>
  
  <footer class="credits-footer" role="contentinfo" aria-label="å‡ºå…¸æƒ…å ±">
    <small>

      (â„¹ï¸ <a id="show-intro-link" href="https://github.com/mtur2007/java_three_3D/blob/main/README.md" target="_blank" rel="noopener noreferrer">æ“ä½œæ–¹æ³•ã¯ã“ã¡ã‚‰</a>)
      [ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ / 
      ãƒ‡ãƒ¼ã‚¿:
      <a href="https://plateauview.mlit.go.jp/" target="_blank" rel="noopener noreferrer">PLATEAU</a>ï¼ˆå›½åœŸäº¤é€šçœï¼‰|
      ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚º: 
      <a href="https://threejs.org/" target="_blank" rel="noopener noreferrer">
      three.js (r0.169.0, MIT)</a> | 
      å¤‰æ›: 
      <a href="https://github.com/Project-PLATEAU/PLATEAU-GIS-Converter" target="_blank" rel="noopener noreferrer">
      PLATEAU GIS Converter</a> ]
    </small>
  </footer>
  
  <script type="module" src="js/main.js"></script>
  <script type="module" src="js/ui_toggle.js"></script>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const inner = document.getElementById('led-marquee-inner');
  if (!inner) return;

  // 3è¡Œã‚»ãƒƒãƒˆï¼štext ã¨ mode ã‚’è¡Œã”ã¨ã«æŒ‡å®š
  // mode: "scroll" | "static"
  const messageSets = [
    [
      { text: '</whiteã‚ˆã†ã“ã â€” ä¸‰æ¬¡å…ƒæ¨¡å‹ãƒ‡ãƒ¢', mode: 'static' },
      { text: '</orangeã“ã®ã‚µã‚¤ãƒˆã§ã¯three.jsã§ä½œæˆã—ãŸç©ºé–“ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚', mode: 'scroll' },
      { text: '', mode: 'static' },
    ],
    [
      { text: '</whiteã‚ˆã†ã“ã â€” ä¸‰æ¬¡å…ƒæ¨¡å‹ãƒ‡ãƒ¢', mode: 'static' },
      { text: '</orangeæ¨¡å‹ã®è¡¨ç¤ºã¯ã‚‚ã¡ã‚ã‚“ã€ç·¨é›†ã‚‚å¯èƒ½ã§ã™ã€‚', mode: 'scroll' },
      { text: '', mode: 'static' },
    ],
    [
      { text: '</whiteã‚ˆã†ã“ã â€” ä¸‰æ¬¡å…ƒæ¨¡å‹ãƒ‡ãƒ¢', mode: 'static' },
      { text: '</orangeç·¨é›†ã«ã¤ã„ã¦ã¯ä¸‹éƒ¨ã‚’ã”è¦§ãã ã•ã„ã€‚', mode: 'scroll' },
      { text: '', mode: 'static' },
    ],
    [
      { text: '</redã²ã‹ã‚Š 513', mode: 'static' },
      { text: '</yellowã®ãã¿ 111 ', mode: 'static' },
      { text: '</blueãŸã‹ã— 657', mode: 'static' },
    ],
    [
      { text: '</greenã€€ã€€æ™®ã€€é€šã€€ã€€ 15:06 éƒ¡å±±</orange 2', mode: 'static' },
      { text: '</redå–œå¤šæ–¹ãƒ©ãƒ¼ãƒ¡ãƒ³ 15:25 éƒ¡å±± 1', mode: 'static' },
      { text: '', mode: 'static' },
    ],
    [
      { text: '</pink ï¼“ </yellow 16:26 å„åœ æ–°ç·šæ–°å®¿ ï¼‘ï¼ä¸¡ç·¨æˆ', mode: 'static' },
      { text: '</pink ï¼“ </yellow 16:27 å„åœ ã€€èª¿å¸ƒã€€ ï¼“ï¼’ï¼—ï¼’ï¼–ï¼˜ä¸¡ç·¨æˆ', mode: 'static' },
      { text: '', mode: 'static' },

    ],
    [
      { text: '</orangeâ˜†æ—¥æœ¬ã¯çµ‚äº†ã—ã¾ã—ãŸâ˜†', mode: 'static' },
      { text: '', mode: 'static' },
      { text: '', mode: 'static' },
    ],
    [
      { text: '</white local</orange 12:38 Naka-meguro </green8car', mode: 'static' },
      { text: '</orangeæ’ƒã¡å›ã‚Šã€å¤–å›ã‚Šé›»è»Šã«é…ã‚ŒãŒå‡ºã¦ãŠã‚Šã¾ã™ã€‚', mode: 'scroll' },
      { text: '</white local</orange 12:48 Naka-meguro </green7car', mode: 'static' },
    ],
    [
      { text: '</greenæ¬¡ã¯ã€€</orangeã‚ªãƒã‚¨ãƒ€', mode: 'static' },
      { text: '', mode: 'static' },
      { text: '', mode: 'static' },
    ],
    [
      { text: '</greenã€€ã€€æ™®ã€€é€šã€€ã€€21:01 è±Šã€€æ©‹ 4ä¸¡', mode: 'static', theme: 'green' },
      { text: '</orangeãŠå®¢æ§˜ã«ã¯å¤§å¤‰ã”è¿·æƒ‘ã—ã¦ãŠã‚Šã¾ã™ã€‚', mode: 'scroll', theme: 'orange'},
      { text: '', mode: 'static' },
    ],
  ];

  const SPEED_PX_PER_SEC = 120;
  const MIN_SEC = 5;
  const MAX_SEC = 120;

  // ãƒ•ã‚©ãƒ³ãƒˆãƒ­ãƒ¼ãƒ‰å¾Œã«è¨ˆæ¸¬ï¼ˆä»»æ„ã ã‘ã©ãŠã™ã™ã‚ï¼‰
  if (document.fonts && document.fonts.ready) {
    try { await document.fonts.ready; } catch (e) {}
  }

  let queue = [];
  let currentIndex = -1;
  const INTRO_COUNT = 3; // æœ€åˆã«é †ç•ªã§æµã™ã‚»ãƒƒãƒˆæ•°
  let introIndex = 0;

  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }
  function refillQueue() {
    queue = messageSets.map((_, i) => i);
    shuffle(queue);
    if (queue.length >= 2 && queue[0] === currentIndex) {
      [queue[0], queue[1]] = [queue[1], queue[0]];
    }
  }
  function pickNextIndex() {
    if (messageSets.length === 0) return -1;
    if (messageSets.length === 1) return 0;

    // æœ€åˆã®3ã‚»ãƒƒãƒˆã¯é †ç•ªå›ºå®š
    if (introIndex < Math.min(INTRO_COUNT, messageSets.length)) {
      return introIndex++;
    }

    if (queue.length === 0) refillQueue();
    return queue.shift();
  }

  function parseColoredText(raw) {
    if (!raw) return '';

    // </colorText ã‚’è§£æ
    // ä¾‹: </greenæ¬¡ã¯ </orangeã‚ªãƒã‚¨ãƒ€
    const regex = /<\/([a-zA-Z0-9_-]+)([^<]*)/g;

    let result = '';
    let lastIndex = 0;
    let match;

    while ((match = regex.exec(raw)) !== null) {
      // ã‚¿ã‚°å‰ã®é€šå¸¸æ–‡å­—
      result += raw.slice(lastIndex, match.index);

      const color = match[1];
      const text  = match[2];

      result += `<span class="led-color-${color}">${text}</span>`;

      lastIndex = regex.lastIndex;
    }

    // æ®‹ã‚Šæ–‡å­—
    result += raw.slice(lastIndex);

    return result;
  }

  function applyRow(rowEl, line) {

    const span = rowEl.querySelector('.led-marquee__text');
    if (!span) return;

    const mode = line?.mode ?? 'scroll';
    const text = line?.text ?? '';

    // ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°
    span.innerHTML = parseColoredText(text);


    // ãƒ¢ãƒ¼ãƒ‰åæ˜ ï¼ˆclassã§åˆ†ã‘ã‚‹ï¼‰
    rowEl.classList.toggle('static', mode === 'static');

    // ã‚¢ãƒ‹ãƒ¡ä¸€æ—¦åœæ­¢ï¼†ã‚¯ãƒªã‚¢
    span.style.animation = 'none';
    span.style.transform = 'translateX(0px)';
    span.style.removeProperty('--row-from');
    span.style.removeProperty('--row-to');
  }

  function startRowAnimation(rowEl) {
    const span = rowEl.querySelector('.led-marquee__text');
    if (!span) return;

    // static ã®è¡Œã¯æµã•ãªã„ï¼ˆå·¦å›ºå®šï¼‰
    if (rowEl.classList.contains('static')) {
      span.style.animation = 'none';
      span.style.transform = 'translateX(0px)';
      return;
    }

    const container = inner.parentElement;
    if (!container) return;

    const containerWidth = container.getBoundingClientRect().width;
    const textWidth = span.getBoundingClientRect().width;

    const from = containerWidth;
    const to = -textWidth;

    span.style.setProperty('--row-from', from + 'px');
    span.style.setProperty('--row-to', to + 'px');

    const distance = containerWidth + textWidth;
    const raw = distance / SPEED_PX_PER_SEC;
    const duration = Math.max(MIN_SEC, Math.min(MAX_SEC, raw));

    // ç¢ºå®Ÿã«ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ
    span.style.animation = 'none';
    void span.offsetWidth;
    span.style.animation = `marqueeRow ${duration}s linear 1 forwards`;
  }

  // 3è¡Œã®ã†ã¡ã€Œæœ€å¾Œã«çµ‚ã‚ã£ãŸ scroll è¡Œã€ã‚’ãƒˆãƒªã‚¬ãƒ¼ã«æ¬¡ã‚»ãƒƒãƒˆã¸
  // â€» ã™ã¹ã¦ static ã®ã‚»ãƒƒãƒˆã§ã‚‚é€²ã‚€ã‚ˆã†ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚‚å…¥ã‚Œã‚‹
  let pendingScrollCount = 0;

  function playSet(index) {
    const set = messageSets[index];
    const rows = inner.querySelectorAll('.led-row');

    pendingScrollCount = 0;

    rows.forEach((rowEl, i) => {
      applyRow(rowEl, set[i]);
    });

    // DOMåæ˜ å¾Œã«è¨ˆæ¸¬ã—ã¦é–‹å§‹
    requestAnimationFrame(() => {
      rows.forEach((rowEl) => {
        if (!rowEl.classList.contains('static')) pendingScrollCount++;
        startRowAnimation(rowEl);
      });

      // å…¨éƒ¨ static ã®ã‚»ãƒƒãƒˆãªã‚‰ã€ä¸€å®šæ™‚é–“å¾Œã«æ¬¡ã¸ï¼ˆè¦‹ã›ã‚‹æ™‚é–“ï¼‰
      if (pendingScrollCount === 0) {
        setTimeout(() => playNext(),  8000);
      }
    });
  }

  function playNext() {
    const next = pickNextIndex();
    if (next < 0) return;
    currentIndex = next;
    playSet(currentIndex);
  }

  // è¡Œã‚¢ãƒ‹ãƒ¡çµ‚äº†ã‚’ç›£è¦–ï¼ˆscroll è¡Œã ã‘ã‚«ã‚¦ãƒ³ãƒˆï¼‰
  inner.addEventListener('animationend', (e) => {
    const span = e.target.closest?.('.led-marquee__text');
    if (!span) return;

    const rowEl = span.closest('.led-row');
    if (!rowEl || rowEl.classList.contains('static')) return;

    pendingScrollCount = Math.max(0, pendingScrollCount - 1);
    if (pendingScrollCount === 0) {
      playNext();
    }
  });

  // hoverã§åœæ­¢ï¼ˆè¡Œã”ã¨ï¼‰
  const marquee = inner.closest('.led-marquee');
  if (marquee) {
    marquee.addEventListener('mouseenter', () => {
      inner.querySelectorAll('.led-marquee__text').forEach(s => s.style.animationPlayState = 'paused');
    });
    marquee.addEventListener('mouseleave', () => {
      inner.querySelectorAll('.led-marquee__text').forEach(s => s.style.animationPlayState = 'running');
    });
  }

  // ãƒªã‚µã‚¤ã‚ºæ™‚ï¼šä»Šã®ã‚»ãƒƒãƒˆã‚’å†ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆã‚ºãƒ¬é˜²æ­¢ï¼‰
  const handleResize = () => {
    if (currentIndex < 0) return;
    playSet(currentIndex);
  };
  if ('ResizeObserver' in window) {
    const ro = new ResizeObserver(() => handleResize());
    ro.observe(inner.parentElement);
  } else {
    window.addEventListener('resize', handleResize, { passive: true });
  }

  playNext();
});
</script>

<script>
window.addEventListener('load', () => {
  const group = document.getElementById('UiGroup');
  if (!group) return;

  let tooltip = document.getElementById('ui-tooltip');
  if (!tooltip) {
    tooltip = document.createElement('div');
    tooltip.id = 'ui-tooltip';
    tooltip.className = 'ui-tooltip';
    tooltip.setAttribute('role', 'tooltip');
    const uiRoot = document.getElementById('three-ui') || document.body;
    uiRoot.appendChild(tooltip);
  }

  const labelsById = {
    'see': 'é‘‘è³ãƒ¢ãƒ¼ãƒ‰',
    'edit': 'ç·¨é›†ãƒ¢ãƒ¼ãƒ‰',
    'rail': 'ãƒ¬ãƒ¼ãƒ«ç·¨é›†',
    'creat': 'ã‚¯ãƒªã‚¨ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰',
    'custom': 'ã‚«ã‚¹ã‚¿ãƒ ç·¨é›†',

    'view': 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º',
    'add_point': 'ãƒã‚¤ãƒ³ãƒˆè¿½åŠ ',
    'y_add': 'ç”Ÿæˆæ™‚ã®é«˜ã•ã®å¤‰æ›´',
    'template': 'ç”Ÿæˆã‚µãƒãƒ¼ã‚¿ãƒ¼ã®è¿½åŠ ',
    'guide': 'ã‚¬ã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼',
    'add': 'ã‚¬ã‚¤ãƒ‰è¿½åŠ ',
    'rotation': 'å›è»¢',
    'rotation/2': 'ãƒã‚¤ãƒ³ãƒˆå›è»¢',
    'move_point': 'ãƒã‚¤ãƒ³ãƒˆç§»å‹•',
    'change_angle': 'ç§»å‹•å¹³é¢ã®è§’åº¦å¤‰æ›´',
    'x_z': 'å¹³é¢(XZè»¸) ç§»å‹•',
    'y': 'å‚ç›´(Yè»¸) ç§»å‹•',
    'x_z_sf': 'å¹³é¢(XZè»¸) å¾®èª¿æ•´',
    'y_sf': 'å‚ç›´(Yè»¸) å¾®èª¿æ•´',
    'construction/2': 'æ§‹é€ ç‰©ç”Ÿæˆ',

    'structure': 'æ§‹é€ ç‰©ãƒ¡ãƒ‹ãƒ¥ãƒ¼',
    'construction': 'æ§‹é€ ç‰©ç”Ÿæˆ',
    'bridge': 'æ©‹æ¢',
    'elevated': 'é«˜æ¶',
    'wall': 'å£',
    'floor': 'åºŠ',
    'pillar': 'æŸ±',
    'rib_bridge': 'ãƒªãƒ–æ©‹',
    'tunnel_rect': 'çŸ©å½¢ãƒˆãƒ³ãƒãƒ«',

    'Round_bar': 'ä¸¸é‹¼',
    'H_beam': 'Hå½¢é‹¼',
    'rite': 'ãƒ©ã‚¤ãƒˆ',
    'tubular': 'ç®¡',

    'new': 'æ–°è¦',
    'move': 'ç§»å‹•',
    'construct': 'æ§‹ç¯‰',
    'new/2': 'æ–°è¦ (æ§‹é€ ç‰©)',
    'move/2': 'ç§»å‹• (ã‚«ã‚¹ã‚¿ãƒ )',
    'x_z/2': 'å¹³é¢(XZè»¸) ç§»å‹• (ã‚«ã‚¹ã‚¿ãƒ )',
    'y/2': 'å‚ç›´(Yè»¸) ç§»å‹• (ã‚«ã‚¹ã‚¿ãƒ )',
  };

  let pressTimer = null;
  let activeBtn = null;

  function showTooltip(btn) {
    const label = labelsById[btn.id] || btn.getAttribute('aria-label') || 'èª¬æ˜æœªè¨­å®š';
    tooltip.textContent = label;

    const btnRect = btn.getBoundingClientRect();
    const left = btnRect.right + 6;
    const top = btnRect.bottom + 6;
    tooltip.style.left = `${left}px`;
    tooltip.style.top = `${top}px`;
    tooltip.style.position = 'fixed';
    tooltip.style.opacity = '1';
    tooltip.style.transform = 'translateY(0)';

    tooltip.classList.add('is-visible');
  }

  function hideTooltip() {
    tooltip.style.opacity = '';
    tooltip.style.transform = '';
    tooltip.classList.remove('is-visible');
  }

  function clearPressTimer() {
    if (pressTimer) {
      clearTimeout(pressTimer);
      pressTimer = null;
    }
  }

  function getBtnFromEvent(e) {
    const btn = e.target.closest?.('button');
    if (!btn || !group.contains(btn)) return null;
    return btn;
  }

  group.addEventListener('pointerover', (e) => {
    const btn = getBtnFromEvent(e);
    if (!btn) return;
    activeBtn = btn;
    showTooltip(btn);
  });

  group.addEventListener('pointerout', (e) => {
    const btn = getBtnFromEvent(e);
    if (!btn) return;
    activeBtn = null;
    hideTooltip();
  });

  group.addEventListener('pointerdown', (e) => {
    const btn = getBtnFromEvent(e);
    if (!btn) return;
    activeBtn = btn;
    clearPressTimer();
    pressTimer = setTimeout(() => {
      showTooltip(btn);
    }, 450);
  });

  group.addEventListener('pointerup', () => {
    clearPressTimer();
    if (!activeBtn) return;
    hideTooltip();
  });

  group.addEventListener('pointercancel', () => {
    clearPressTimer();
    if (!activeBtn) return;
    hideTooltip();
  });

  // Fallback for environments where pointer events are not reliable
  group.addEventListener('mouseover', (e) => {
    const btn = getBtnFromEvent(e);
    if (!btn) return;
    activeBtn = btn;
    showTooltip(btn);
  });
  group.addEventListener('mouseout', (e) => {
    const btn = getBtnFromEvent(e);
    if (!btn) return;
    activeBtn = null;
    hideTooltip();
  });
  group.addEventListener('touchstart', (e) => {
    const btn = getBtnFromEvent(e);
    if (!btn) return;
    activeBtn = btn;
    clearPressTimer();
    pressTimer = setTimeout(() => {
      showTooltip(btn);
    }, 450);
  }, { passive: true });

  // Click fallback (debug / desktop)
  group.addEventListener('click', (e) => {
    const btn = getBtnFromEvent(e);
    if (!btn) return;
    showTooltip(btn);
    setTimeout(() => {
      if (activeBtn === btn) return;
      hideTooltip();
    }, 1200);
  });
});
</script>

</body>
</html>
