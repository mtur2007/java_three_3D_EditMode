<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>PLATEAU - ä¸­å¤®åŒº 3D Tiles</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
  </style>
</head>
<body>
  <script type="module">
    // three ã‚’ esm.sh ã‹ã‚‰èª­ã¿è¾¼ã¿
    import * as THREE from "https://esm.sh/three@0.169";

    // OrbitControls ã‚‚ esm.sh ã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆä¾å­˜ãŒè‡ªå‹•è§£æ±ºã•ã‚Œã‚‹ï¼‰
    import { OrbitControls } from "https://esm.sh/three@0.169/examples/jsm/controls/OrbitControls.js";

    import { TilesRenderer } from 'https://esm.sh/3d-tiles-renderer@0.3.19';

    // ã‚·ãƒ¼ãƒ³
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xa0c8ff);

    // ã‚«ãƒ¡ãƒ©
    const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 100000);
    camera.position.set(139.77, 300, 139.77); // åˆæœŸä½ç½®ã¯é©å½“

    // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // ãƒ©ã‚¤ãƒˆ
    const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1.0);
    hemiLight.position.set(0, 200, 0);
    scene.add(hemiLight);

    const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
    dirLight.position.set(100, 200, 100);
    scene.add(dirLight);

    // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.target.set(0, 0, 0);

    // TilesRenderer
    const path = 'bldg/13100_tokyo/13102_chuo-ku/notexture';
    const tiles = new TilesRenderer(
      `https://plateau.geospatial.jp/main/data/3d-tiles/${path}/tileset.json`
    );
    // https://plateau.geospatial.jp/main/data/3d-tiles/bldg/13100_tokyo/13102_chuo-ku/notexture/tileset.json
    tiles.setCamera(camera);
    tiles.setResolutionFromRenderer(camera, renderer);
    scene.add(tiles.group);

    // èª­ã¿è¾¼ã¿å®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆ
    tiles.onLoadTileSet = () => {
      console.log('âœ… ä¸­å¤®åŒºã® PLATEAU ã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†');

      // ã‚¿ã‚¤ãƒ«å…¨ä½“ã®ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚’å–å¾—
      const box = tiles.getBoundingBox(new THREE.Box3());
      const center = new THREE.Vector3();
      box.getCenter(center);

      console.log("ðŸ“ å»ºç‰©ä¸­å¿ƒåº§æ¨™:", center);

      // ã‚«ãƒ¡ãƒ©ã‚’å»ºç‰©ã®ä¸­å¿ƒã«ç§»å‹•
      camera.position.set(center.x, center.y + 500, center.z + 500);
      camera.lookAt(center);

      // OrbitControls ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’æ›´æ–°
      controls.target.copy(center);
      controls.update();
    };


    // æ¯Žãƒ•ãƒ¬ãƒ¼ãƒ æ›´æ–°
    function animate() {
    
      requestAnimationFrame(animate);
      tiles.update();
      renderer.render(scene, camera);
    }
    animate();

    // ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
