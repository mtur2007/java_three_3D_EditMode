<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>PLATEAU - 中央区 3D Tiles</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
  </style>
</head>
<body>
  <script type="module">
    // three を esm.sh から読み込み
    import * as THREE from "https://esm.sh/three@0.169";

    // OrbitControls も esm.sh から読み込み（依存が自動解決される）
    import { OrbitControls } from "https://esm.sh/three@0.169/examples/jsm/controls/OrbitControls.js";

    import { TilesRenderer } from 'https://esm.sh/3d-tiles-renderer@0.3.19';

    // シーン
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xa0c8ff);

    // カメラ
    const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 100000);
    camera.position.set(139.77, 300, 139.77); // 初期位置は適当

    // レンダラー
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // ライト
    const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1.0);
    hemiLight.position.set(0, 200, 0);
    scene.add(hemiLight);

    const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
    dirLight.position.set(100, 200, 100);
    scene.add(dirLight);

    // コントロール
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.target.set(0, 0, 0);

    // TilesRenderer
    const path = 'bldg/13100_tokyo/13102_chuo-ku/notexture';
    const tiles = new TilesRenderer(
      `https://plateau.geospatial.jp/main/data/3d-tiles/${path}/tileset.json`
    );
    // https://plateau.geospatial.jp/main/data/3d-tiles/bldg/13100_tokyo/13102_chuo-ku/notexture/tileset.json
    tiles.setCamera(camera);
    tiles.setResolutionFromRenderer(camera, renderer);
    scene.add(tiles.group);

    // 読み込み完了イベント
    tiles.onLoadTileSet = () => {
      console.log('✅ 中央区の PLATEAU タイル読み込み完了');

      // タイル全体のバウンディングボックスを取得
      const box = tiles.getBoundingBox(new THREE.Box3());
      const center = new THREE.Vector3();
      box.getCenter(center);

      console.log("📍 建物中心座標:", center);

      // カメラを建物の中心に移動
      camera.position.set(center.x, center.y + 500, center.z + 500);
      camera.lookAt(center);

      // OrbitControls のターゲットを更新
      controls.target.copy(center);
      controls.update();
    };


    // 毎フレーム更新
    function animate() {
    
      requestAnimationFrame(animate);
      tiles.update();
      renderer.render(scene, camera);
    }
    animate();

    // リサイズ対応
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
